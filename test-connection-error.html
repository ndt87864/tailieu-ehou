<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connection Error Handling</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .test-step {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .error-info {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
            background: #f8d7da;
            border-radius: 0 8px 8px 0;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .code {
            background: #f1f3f4;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Test Connection Error Handling</h1>
        <p>Ki·ªÉm tra vi·ªác x·ª≠ l√Ω l·ªói "Could not establish connection"</p>
    </div>

    <div class="test-container">
        <h2>üêõ V·∫•n ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c s·ª≠a</h2>
        
        <div class="error-info">
            <strong>L·ªói g·ªëc:</strong><br>
            <code>Failed to update questions popup: Error: Could not establish connection. Receiving end does not exist.</code>
        </div>
        
        <div class="test-step">
            <strong>‚úÖ Nguy√™n nh√¢n:</strong> Extension popup c·ªë g·∫Øng g·ª≠i message ƒë·∫øn content script khi content script ch∆∞a ƒë∆∞·ª£c load ho·∫∑c ƒë√£ b·ªã h·ªßy
        </div>
        
        <div class="test-step">
            <strong>‚úÖ Gi·∫£i ph√°p:</strong> Th√™m error handling graceful v·ªõi auto-injection v√† retry logic
        </div>
    </div>

    <div class="test-container">
        <h2>üîß C·∫£i ti·∫øn ƒë√£ th·ª±c hi·ªán</h2>
        
        <div class="test-step">
            <strong>1. Tab Validation:</strong> Ki·ªÉm tra tab c√≥ s·∫µn s√†ng nh·∫≠n message kh√¥ng
        </div>
        
        <div class="test-step">
            <strong>2. Message Timeout:</strong> Timeout 3 gi√¢y ƒë·ªÉ tr√°nh hang
        </div>
        
        <div class="test-step">
            <strong>3. Auto Content Script Injection:</strong> T·ª± ƒë·ªông inject content script khi c·∫ßn
        </div>
        
        <div class="test-step">
            <strong>4. Retry Logic:</strong> Th·ª≠ l·∫°i sau khi inject content script
        </div>
        
        <div class="test-step">
            <strong>5. Graceful Fallback:</strong> Kh√¥ng throw error ƒë·ªÉ tr√°nh break popup
        </div>
    </div>

    <div class="test-container">
        <h2>üìù Code c·∫£i ti·∫øn</h2>
        
        <div class="code">
// Tr∆∞·ªõc (g√¢y l·ªói):
async function updateQuestionsPopup(questions) {
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    await chrome.tabs.sendMessage(tab.id, { /* message */ });
    // ‚ùå Throw error n·∫øu content script kh√¥ng c√≥
}

// Sau (x·ª≠ l√Ω l·ªói):
async function updateQuestionsPopup(questions) {
    // ‚úÖ Validate tab
    // ‚úÖ Check tab status  
    // ‚úÖ Timeout protection
    // ‚úÖ Auto content script injection
    // ‚úÖ Retry logic
    // ‚úÖ Graceful error handling
}
        </div>
    </div>

    <div class="test-container">
        <h2>üß™ C√°ch test</h2>
        
        <div class="test-step">
            <strong>Scenario 1:</strong> M·ªü extension tr√™n trang m·ªõi (content script ch∆∞a load)
        </div>
        
        <div class="test-step">
            <strong>Scenario 2:</strong> Reload extension khi ƒëang d√πng
        </div>
        
        <div class="test-step">
            <strong>Scenario 3:</strong> M·ªü extension tr√™n chrome:// pages
        </div>
        
        <div class="test-step">
            <strong>Scenario 4:</strong> Tab ƒëang loading
        </div>
        
        <div class="test-step">
            <strong>K·∫øt qu·∫£ mong ƒë·ª£i:</strong> <span class="success">Kh√¥ng c√≥ error trong console, extension ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</span>
        </div>
    </div>

    <div class="test-container">
        <h2>üìä Console Logs</h2>
        <div class="logs" id="consoleLogs">
            <div>üîç M·ªü F12 Console ƒë·ªÉ xem logs chi ti·∫øt...</div>
        </div>
    </div>

    <script>
        console.log('üß™ Connection Error Test Page loaded');
        
        // Capture console logs for display
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const logsContainer = document.getElementById('consoleLogs');
        
        function addLogToUI(message, type = 'log') {
            const logLine = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            logLine.innerHTML = `<span style="color: #888">[${timestamp}]</span> <span style="color: ${type === 'error' ? '#ff6b6b' : '#4ecdc4'}">${message}</span>`;
            logsContainer.appendChild(logLine);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addLogToUI(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLogToUI('‚ùå ' + args.join(' '), 'error');
        };
        
        // Test functions
        window.testExtensionConnection = function() {
            console.log('=== TESTING EXTENSION CONNECTION ===');
            console.log('Page URL:', window.location.href);
            console.log('Page ready state:', document.readyState);
            console.log('Extension should handle connection gracefully now');
        };
        
        // Auto-test
        setTimeout(window.testExtensionConnection, 2000);
        
        // Show different scenarios
        console.log('üìã Test scenarios:');
        console.log('1. Open popup on this page (new tab)');
        console.log('2. Select documents and load questions');
        console.log('3. Check for connection errors in console');
        console.log('4. Verify extension works without throwing errors');
    </script>
</body>
</html>